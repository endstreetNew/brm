<div class="whiteArea col">
    <div class="row">
        <div class="whiteArea col">
            @if (boxfiles != null)
            {
                if (boxfiles.count == 0)
                {
                    <div class="row">
                        <div class="col">
                            <h5>No Closed Boxes ready for dispatch.</h5>
                        </div>
                    </div>
                }
                else
                {
                    <div class="row">
                        <div>
                            <div class="input-group mb-3">
                                <button type="button" class="btn btn-warning btn-sm active" style="width: 160px; margin: 5px 0 5px;" @onclick="@(() => btnPrint_Click())" disabled="@(!boxfiles.result.Where(b => b.IsSelected).Any())">Dispatch</button>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <table class="table table-sm" style="font-size:small;">
                            <thead>
                                <tr>
                                    <th scope="col">Select</th>
                                    <th scope="col">Box No</th>
                                    <th scope="col">MiniBoxes</th>
                                    <th scope="col">LC Files</th>
                                    <th scope="col">Region</th>

                                </tr>
                            </thead>
                            <tbody>
                                @foreach (TdwBatchViewModel p in boxfiles.result)
                                {
                                    <tr>
                                        <td>
                                            <div style="vertical-align: middle; display: table-cell; padding: 0 5px 0 5px;">
                                                <input type="checkbox" @bind="@p.IsSelected" />
                                            </div>
                                        </td>
                                        <td>@p.BoxNo</td>
                                        <td>@p.MiniBoxes</td>
                                        <td>@p.Files</td>
                                        <td>@p.Region</td>

                                    </tr>
                                }
                            </tbody>
                        </table>
                        <Pager Paged="OnPaged" TotalSize="@boxfiles.count" PageSize="20"></Pager>
                    </div>
                }
            }
            else
            {
                <div class="row">
                    <div class="col">
                        <h5>Loading...</h5>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {

    [Parameter]
    public string boxNo { get; set; }

    protected bool BoxLocked;
    protected string RemoveBarcode;

    protected string searchText;

    //private ElementReference brmInput;

    protected Reboxing rebox = new Reboxing();
    //bool loaded = false;

    PagedResult<TdwBatchViewModel> boxfiles;
    PagedResult<TdwBatchViewModel> batchedfiles;


    int page = 1;
    int historypage = 1;


    protected override async Task OnInitializedAsync()
    {
        //todo: Fix with new service
        boxfiles = await db.GetAllBoxes(page);
        sessionservice.session.BookMark.BoxingTab = 4;
    }

    protected async Task btnPrint_Click()
    {
        int tdwBatch = await db.CreateTdwBatch(boxfiles.result.Where(b => b.IsSelected).ToList());
        btnPrint_Click(tdwBatch);
    }

    protected void btnPrint_Click(int tdwBatch)
    {
        Navigate.NavigateTo($"tdwbatchcover/{tdwBatch}");
    }

    protected async Task OnPaged(int _page)
    {
        page = _page;
        //todo:fix
        boxfiles = await db.GetAllBoxes(page);
    }


}
